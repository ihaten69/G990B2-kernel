name: Build S21FE Kernel (Custom Container with Neutron Clang)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARCH: arm64
      SUBARCH: arm64
      DEVICE_DEFCONFIG: r9q_eur_openx2_defconfig
      TOOLCHAIN_DIR: ${{ github.workspace }}/toolchains/neutron-clang

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4

      - name: Build Custom Docker Image with GLIBC 2.38+
        run: |
          cat > Dockerfile <<EOF
          FROM ubuntu:23.04

          RUN apt-get update && \
              apt-get install -y bc bison build-essential curl flex git libncurses5-dev python3 unzip zip wget zstd

          ENV PATH="/root/toolchains/neutron-clang/bin:\$PATH"
          EOF

          docker build -t custom-neutron-clang .

      - name: Run Kernel Build in Custom Container
        run: |
          mkdir -p $TOOLCHAIN_DIR
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace custom-neutron-clang /bin/bash -c "
            echo 'Downloading AntMan and syncing Neutron Clang...'
            mkdir -p /root/toolchains/neutron-clang &&
            cd /root/toolchains/neutron-clang &&
            curl -LO https://raw.githubusercontent.com/Neutron-Toolchains/antman/main/antman &&
            chmod +x antman &&
            ./antman -S &&
            export PATH=/root/toolchains/neutron-clang/bin:\$PATH &&
            echo 'Configuring Kernel...' &&
            make O=out $DEVICE_DEFCONFIG CC=clang LLVM=1 LLVM_IAS=1 &&
            echo 'Building Kernel...' &&
            make O=out CC=clang LLVM=1 LLVM_IAS=1 -j$(nproc) &&
            echo 'Packaging Kernel...' &&
            git clone https://github.com/osm0sis/AnyKernel3.git &&
            cp out/arch/arm64/boot/Image* AnyKernel3/ &&
            cd AnyKernel3 &&
            zip -r9 ../S21FE-Kernel-Neutron.zip * &&
            echo 'Kernel build complete.'
          "

      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: S21FE-Kernel-Neutron
          path: S21FE-Kernel-Neutron.zip
